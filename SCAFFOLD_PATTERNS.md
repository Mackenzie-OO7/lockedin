# Scaffold Stellar Patterns for LockedIn

## ğŸ“š Key Learnings from Scaffold Tutorial

### Project Structure (MUST FOLLOW)
```
lockedin/
â”œâ”€â”€ .env                          # Environment config
â”œâ”€â”€ Cargo.toml                    # Rust workspace
â”œâ”€â”€ contracts/                    # Smart contracts
â”‚   â”œâ”€â”€ lockedin/                # OUR custom contract
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ lib.rs           # Main contract
â”‚   â”‚       â”œâ”€â”€ error.rs         # Error types
â”‚   â”‚       â””â”€â”€ test.rs          # Tests
â”‚   â”œâ”€â”€ guess-the-number/        # Example (keep for reference)
â”‚   â””â”€â”€ ... other examples
â”œâ”€â”€ packages/                     # Auto-generated TypeScript clients
â”‚   â”œâ”€â”€ lockedin/                # Generated by Scaffold
â”‚   â””â”€â”€ ... other clients
â”œâ”€â”€ src/                          # Frontend React app
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ contracts/               # Contract wrappers
â”‚   â”‚   â”œâ”€â”€ lockedin.ts         # We'll create this
â”‚   â”‚   â””â”€â”€ util.ts             # Shared utilities
â”‚   â”œâ”€â”€ pages/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ environments.toml             # Deployment config
â””â”€â”€ rust-toolchain.toml          # Rust version
```

---

## ğŸ¯ Contract Structure Pattern

### From guess-the-number example:

```rust
#![no_std]
use soroban_sdk::{contract, contractimpl, symbol_short, Address, Env, Symbol};

mod error;  // Separate error module

#[contract]
pub struct GuessTheNumber;  // Empty struct

const THE_NUMBER: &Symbol = &symbol_short!("n");  // Storage keys
pub const ADMIN_KEY: &Symbol = &symbol_short!("ADMIN");

#[contractimpl]
impl GuessTheNumber {
    /// Constructor runs on deployment
    pub fn __constructor(env: &Env, admin: Address) {
        admin.require_auth();
        Self::set_admin(env, admin);
    }

    /// Public functions (exported to blockchain)
    pub fn some_function(env: &Env) {
        Self::require_admin(env);
        // logic
    }

    /// Private helpers (not exported)
    fn require_admin(env: &Env) {
        let admin = Self::admin(env).expect("admin not set");
        admin.require_auth();
    }
}
```

---

## ğŸ“ Apply to LockedIn Contract

### File Structure:
```
contracts/lockedin/
â”œâ”€â”€ Cargo.toml
â””â”€â”€ src/
    â”œâ”€â”€ lib.rs       # Main contract logic
    â”œâ”€â”€ error.rs     # Error types
    â”œâ”€â”€ types.rs     # Data structures (BillCycle, Bill, etc.)
    â””â”€â”€ test.rs      # Unit tests
```

### Cargo.toml:
```toml
[package]
name = "lockedin"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]

[dependencies]
soroban-sdk = "21.0.0"

[dev-dependencies]
soroban-sdk = { version = "21.0.0", features = ["testutils"] }
```

---

## ğŸ”§ environments.toml Configuration

### For LockedIn:
```toml
# Development (local network)
[development]
network = {
    name = "local",
    run_locally = true
}
accounts = ["admin", "user1", "user2"]

[development.contracts.lockedin]
client = true
constructor_args = """
    --admin $(stellar keys address admin)
"""
after_deploy = """
    # Set initial fee percentage (1%)
    STELLAR_ACCOUNT=admin set_fee_percentage --fee 100
"""

# Testnet
[testnet]
network = { name = "testnet" }
accounts = ["admin"]

[testnet.contracts.lockedin]
client = true
constructor_args = """
    --admin $(stellar keys address admin)
"""

# Production
[production]
network = { name = "mainnet" }

[production.contracts.lockedin]
client = true
id = "C..."  # Will set after deployment
```

---

## ğŸ¨ Frontend Integration Pattern

### Contract Wrapper (src/contracts/lockedin.ts):
```typescript
import * as Client from "lockedin";
import { rpcUrl } from "./util";

export default new Client.Contract({
  ...Client.networks.standalone,  // or testnet/mainnet
  rpcUrl,
  allowHttp: true,
  publicKey: undefined,
});
```

### Usage in Components:
```typescript
import vault from "../contracts/lockedin";

// In component:
const createCycle = async () => {
  const { result } = await vault.create_cycle({
    start_date: BigInt(startDate),
    end_date: BigInt(endDate),
  });

  const cycleId = result.unwrap();
  console.log("Cycle created:", cycleId);
};
```

---

## ğŸš€ Development Workflow

### 1. Initialize (Already Done):
```bash
stellar scaffold init lockedin
cd lockedin
npm install
```

### 2. Add Our Custom Contract:
```bash
# Create contract structure
mkdir -p contracts/lockedin/src
touch contracts/lockedin/Cargo.toml
touch contracts/lockedin/src/lib.rs
touch contracts/lockedin/src/error.rs
touch contracts/lockedin/src/types.rs
touch contracts/lockedin/src/test.rs
```

### 3. Update Workspace Cargo.toml:
```toml
[workspace]
members = [
    "contracts/lockedin",
    "contracts/guess-the-number",
    "contracts/fungible-allowlist",
    "contracts/nft-enumerable",
]
```

### 4. Development Loop:
```bash
npm start
# This runs: stellar scaffold watch --build-clients
# Which:
# - Watches contracts/ for changes
# - Rebuilds on save
# - Deploys to local network
# - Generates TypeScript clients
# - Hot-reloads frontend
```

### 5. Build Manually (if needed):
```bash
stellar scaffold build --build-clients
```

---

## ğŸ” Storage Keys Pattern

### From example contracts:
```rust
// Use Symbol for keys
const KEY_NAME: &Symbol = &symbol_short!("key");

// Or use enums for complex keys
#[contracttype]
pub enum DataKey {
    Admin,
    Cycle(u64),
    Bill(u64),
}

// Access storage
env.storage().instance().set(&DataKey::Admin, &admin);
let admin: Address = env.storage().instance().get(&DataKey::Admin).unwrap();
```

---

## ğŸ¯ Constructor Pattern

### Required for Scaffold:
```rust
pub fn __constructor(env: &Env, admin: Address) {
    admin.require_auth();

    // Initialize contract state
    env.storage().instance().set(&ADMIN_KEY, &admin);
    env.storage().instance().set(&FEE_PERCENTAGE, &100_u32);  // 1%
}
```

### After Deploy Script (environments.toml):
```toml
after_deploy = """
    # Run setup commands after deployment
    STELLAR_ACCOUNT=admin initialize_pool --amount 1000
"""
```

---

## ğŸ“¦ TypeScript Client Generation

### Automatic Process:
1. Contract compiles to WASM
2. Scaffold extracts contract spec
3. Generates TypeScript client in `packages/lockedin/`
4. Creates types for all contract methods
5. Frontend imports and uses

### Generated Structure:
```
packages/lockedin/
â”œâ”€â”€ dist/
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ index.d.ts
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

### Usage:
```typescript
// Fully typed!
import vault from "../contracts/lockedin";

// TypeScript knows these types:
const result = await vault.create_cycle({
  start_date: BigInt(start),  // i128 â†’ BigInt
  end_date: BigInt(end),
});
```

---

## ğŸ§ª Testing Pattern

### Unit Tests (contracts/lockedin/src/test.rs):
```rust
#![cfg(test)]

use super::*;
use soroban_sdk::{testutils::Address as _, Address, Env};

#[test]
fn test_create_cycle() {
    let env = Env::default();
    let contract_id = env.register_contract(None, LockedIn);
    let client = LockedInClient::new(&env, &contract_id);

    let admin = Address::generate(&env);
    let user = Address::generate(&env);

    // Initialize
    client.initialize(&admin);

    // Test
    env.mock_all_auths();
    let cycle_id = client.create_cycle(&user, &start, &end);

    assert_eq!(cycle_id, 0);
}
```

---

## ğŸ“‹ Critical Scaffold Rules

### DO:
1. âœ… Keep contracts in `contracts/` directory
2. âœ… Let Scaffold generate TypeScript clients (don't edit `packages/`)
3. âœ… Use `environments.toml` for deployment config
4. âœ… Use `npm start` for development (hot reload)
5. âœ… Use `#[contract]` and `#[contractimpl]` macros
6. âœ… Name your contract struct (e.g., `pub struct LockedIn;`)
7. âœ… Use `__constructor` for initialization
8. âœ… Follow Scaffold's project structure

### DON'T:
1. âŒ Manually edit generated clients in `packages/`
2. âŒ Create custom build scripts (use Scaffold's)
3. âŒ Ignore `environments.toml` structure
4. âŒ Deploy manually (use Scaffold commands)
5. âŒ Change Scaffold's directory structure
6. âŒ Over-engineer outside Scaffold patterns

---

## ğŸ” Debugger Integration

### Automatic Features:
- Contract explorer at `/debug` route
- Shows all deployed contracts
- Lists methods with documentation
- Interactive method execution
- Transaction history

### For LockedIn:
1. Navigate to http://localhost:5173/debug
2. Select "lockedin" contract
3. See all methods (create_cycle, add_bill, etc.)
4. Execute with parameters
5. View results

---

## ğŸš¢ Deployment to Testnet

### Update .env:
```env
STELLAR_SCAFFOLD_ENV=testnet
PUBLIC_STELLAR_NETWORK=TESTNET
PUBLIC_STELLAR_RPC_URL="https://soroban-testnet.stellar.org"
```

### Build & Deploy:
```bash
stellar scaffold build --build-clients
```

### Or Use Registry:
```bash
# Publish to registry
stellar registry publish \
  --wasm target/stellar/release/lockedin.wasm \
  --wasm-name lockedin \
  --binver "0.1.0"

# Deploy instance
stellar registry deploy \
  --contract-name lockedin \
  --wasm-name lockedin \
  -- \
  __constructor \
  --admin GXXXXXX...
```

---

## ğŸ“ Implementation Checklist

### Contract Setup:
- [ ] Create `contracts/lockedin/` directory
- [ ] Add to workspace in root `Cargo.toml`
- [ ] Create contract `Cargo.toml`
- [ ] Create `lib.rs`, `error.rs`, `types.rs`, `test.rs`

### environments.toml:
- [ ] Add `[development.contracts.lockedin]`
- [ ] Set `client = true`
- [ ] Configure `constructor_args`
- [ ] Add `after_deploy` if needed

### Frontend Integration:
- [ ] Create `src/contracts/lockedin.ts` wrapper
- [ ] Import in components
- [ ] Use generated TypeScript client
- [ ] Follow existing component patterns

### Development:
- [ ] Run `npm start`
- [ ] Watch for auto-rebuild on save
- [ ] Test in browser at localhost:5173
- [ ] Use `/debug` route for testing

---

## âœ… Ready to Build!

**Next Steps:**
1. Create contract structure
2. Implement `lib.rs` with security patterns
3. Add error codes
4. Define data types
5. Write constructor
6. Implement core methods
7. Test
8. Integrate frontend

**Remember:** Keep it simple, follow Scaffold patterns, don't over-engineer!

---

**Last Updated:** [Date]
**Status:** Ready to code
**Next:** Begin Day 1 - Smart Contract Implementation
